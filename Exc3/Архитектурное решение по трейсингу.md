## Мотивация:
1) Решение проблемы с потерянными заказами.
2) Выявление утерянных событий в брокере сообщений (RabbitMQ).
3) Возможность анализа производительности каждого этапа обработки заказов.
4) Упрощение поиска узких мест в системе, ускорение реализации полноценного логирования каждого этапа процесса.

## Предлагаемое решение:
Использование **OpenTelemetry** для сбора данных о трейсах, с визуализацией в **Zipkin** или **Jaeger**.  
Интеграция трейсинг-данных с **ELK** (и, при необходимости, с Grafana) для последующего анализа и визуализации логов.  
Основные системы, подключенные к трейсингу:
- **API Gateway**: отслеживание входящих запросов, ответов и времени выполнения.
- **RabbitMQ**: анализ событий брокера, маршрутов, утерянных сообщений.
- **Shop API и MES API**: каждый бизнес-этап обработки заказа будет включен в трейсинг (например, состояния заказов, передача данных между сервисами).
- **3D-хранилище (S3)**: отслеживание операций записи и чтения 3D-файлов.
- **PostgreSQL-хранилища**: отслеживание медленных запросов и взаимодействий с СУБД.

## Данные для отслеживания:
1) **API Gateway**:
    - Метрики запросов (входящие/исходящие).
    - Ошибки (5xx / 4xx) с указанием контекста.
    - Время ответа для каждого запроса.
    - Уникальные идентификаторы трейсинга для прохождения цепочки.

2) **RabbitMQ**:
    - Данные о каждом событии: отправка сообщений, обработка, отклоненные или потерянные события.
    - Задержка обработки сообщений в очередях.
    - Ошибки при подключении.

3) **Shop API и MES API**:
    - Производительность бизнес-операций, таких как создание заказа, изменение статуса, выполнение расчета (например, цены изделия).
    - Исключения внутри операций.
    - Время выполнения межсервисных взаимодействий.

4) **S3-хранилище**:
    - Метрики по скорости чтения/записи.
    - Успешные операции, неуспешные попытки.

5) **PostgreSQL**:
    - Время выполнения запросов к базе данных.
    - Задержки на выполнение транзакций.
    - Блокировки и deadlock-и.

6) **Общие данные (контекст трейсинга)**:
    - Уникальные идентификаторы трейсинга (traceID, spanID).
    - Временные метки событий – начало, завершение операции.
    - Логирование специфических ошибок и результатов.

## Процесс трейсинга:
1) **Инициализация запроса**:  
   Клиент отправляет запрос через API Gateway. Система генерирует `traceID` для этого запроса, чтобы отслеживать его в дальнейшем по всей цепочке.

2) **Передача данных через RabbitMQ**:  
   События обрабатываются и отправляются между микросервисами, включая `traceID` каждого события.

3) **Обработка данных API сервиса (Shop/MES API)**:  
   Включает фиксацию бизнес-операций, времени их выполнения и возможных ошибок.

4) **Операции с базами данных и S3**:  
   Отслеживаются взаимодействия с PostgreSQL и S3 (время выполнения операций, ошибки).

5) **Визуализация в Zipkin/Jaeger**:  
   Вся цепочка событий (API Gateway → RabbitMQ → MES API → DB → S3) визуализируется с разбиением по временным вложениям.

6) **Эмиссия данных в ELK**:  
   Если в ходе трейсинга были зафиксированы ошибки, они также отправляются в Logstash для обработки и последующего анализа в Kibana.

## Компромиссы:
- **MES API** может требовать значительных доработок для внедрения OpenTelemetry.
- Возможно увеличение нагрузки на системы при большом количестве трейсинга данных, требуем усиленный контроль трафика.

### Аспекты безопасности:
- **Роли и доступ**: Метрики и данные трейсинга доступны только для пользователей с соответствующими ролями (разработчики, поддержка).
- **Обработка данных**: В трейсинге исключаются персональные данные пользователей (например, имена, адреса, платежная информация).

## Системы для трейсинга:
[Диаграмма](diagram.puml)